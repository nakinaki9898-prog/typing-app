<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆä¸­å­¦ç”Ÿï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Mochiy+Pop+One&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans JP',sans-serif;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh}
.card{background:rgba(255,255,255,0.92);border-radius:20px;box-shadow:0 8px 20px rgba(0,0,0,0.15);padding:40px;text-align:center;width:90%;max-width:480px}
h1{color:#1976d2;font-family:'Mochiy Pop One',sans-serif;margin-bottom:16px}
#levelButtons{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.level-btn{background:#1976d2;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;font-size:1.1em}
.level-btn:hover{background:#0d47a1}
button{background:#1976d2;color:#fff;padding:10px 24px;border-radius:10px;border:none;cursor:pointer;margin-top:8px}
button:hover{background:#0d47a1}
input{width:80%;padding:10px;font-size:1.2em;border:2px solid #90caf9;border-radius:10px;caret-color:transparent;user-select:none}
#jp{font-size:1.5em;margin:15px 0}
#word{font-size:2em;min-height:60px;margin-bottom:10px}
#result{height:24px;margin-top:6px}
.wrong{color:red;font-weight:bold}
#progress{font-size:1.2em;margin-bottom:10px;color:#333;font-weight:bold}
#bg{background-color:#e8f3ff!important;background-image:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nNjAnIGhlaWdodD0nNjAnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc+PHJlY3Qgd2lkdGg9JzYwJyBoZWlnaHQ9JzYwJyBmaWxsPSIjZWZmNyIvPjxnIGZpbGw9IiNhOGNkZmYiIGZpbGwtb3BhY2l0eT0iMC40Ij48Y2lyY2xlIGN4PSIxNSIgY3k9IjE0IiByPSI0Ii8+PHJlY3QgeD0iMzAiIHk9IjMxIiB3aWR0aD0iOCIgaGVpZ2h0PSIzIi8+PC9nPjx0ZXh0IHg9IjE4IiB5PSI0NyIgZm9udC1zaXplPSIxMCIgZmlsbD0iI2E2YTZhNiI+QUJDPjwvdGV4dD48L3N2Zz4=");background-size:140px;background-repeat:repeat!important}
</style>
</head>
<body id="bg">

<!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="card" id="menu">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆä¸­å­¦ç”Ÿï¼‰</h1>
  <h2>ãƒ¬ãƒ™ãƒ«é¸æŠ</h2>
  <div id="levelButtons"></div>
</div>

<!-- ã‚²ãƒ¼ãƒ  -->
<div class="card" id="game" style="display:none;">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>

  <!-- å•é¡Œé€²æ— -->
  <div id="progress"></div>

  <div>çµŒéæ™‚é–“: <span id="timer">0</span> ç§’</div>
  <div id="jp"></div>
  <div id="word"></div>

  <!-- å…¥åŠ›æ¬„ã¯è¡¨ç¤ºç”¨ï¼ˆreadonlyï¼‰ã€‚ã‚­ãƒ¼å…¥åŠ›ã¯documentã§å–å¾— -->
  <input id="input" readonly placeholder="ã“ã“ã«å…¥åŠ›ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã‚¿ã‚¤ãƒ—ï¼‰">

  <button onclick="showAnswer()" style="background:#ff9800;margin-top:6px;">ç­”ãˆã‚’è¦‹ã‚‹</button>

  <div id="result"></div>

  <button id="soundBtn" onclick="toggleSound()">ğŸ”Š éŸ³ ON</button>
  <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- çµæœ -->
<div class="card" id="resultCard" style="display:none;">
  <h1>çµæœ</h1>
  <p id="finalScore"></p>
  <p id="summaryScore" style="font-size:1.3em;font-weight:bold;"></p>
  <div id="resultActions"><button onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button></div>
</div>

<script>
/* ====== çŠ¶æ…‹ ====== */
let words=[], index=0, correct=0, currentPos=0, wrongCount=0;
let wrongWords=[], hintShown=false, answerShown=false;
let soundOn=true, timeElapsed=0, timerInterval=null;

/* ====== è¦ç´  ====== */
const jpDiv=document.getElementById("jp");
const wordDiv=document.getElementById("word");
const input=document.getElementById("input");
const result=document.getElementById("result");
const menu=document.getElementById("menu");
const game=document.getElementById("game");
const resultActions=document.getElementById("resultActions");
const progress=document.getElementById("progress");
const timerSpan=document.getElementById("timer");

/* ====== åŠ¹æœéŸ³ ====== */
function tone(f=440,d=0.15,t="sine"){ if(!soundOn) return; const c=new(window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(), g=c.createGain(); o.type=t; o.frequency.value=f; g.gain.value=0.03; o.connect(g); g.connect(c.destination); o.start(); o.stop(c.currentTime+d); }
function playCorrect(){ tone(880,0.12); tone(1100,0.12); }
function playWrong(){ tone(200,0.15,"square"); }
function playFinish(){ tone(440,0.2,"triangle"); setTimeout(()=>tone(660,0.2,"triangle"),200); setTimeout(()=>tone(880,0.2,"triangle"),400); }
function speak(t){ const u=new SpeechSynthesisUtterance(t); u.lang="en-US"; speechSynthesis.speak(u); }
function toggleSound(){ soundOn=!soundOn; document.getElementById("soundBtn").textContent=soundOn?"ğŸ”Š éŸ³ ON":"ğŸ”‡ éŸ³ OFF"; }

/* ====== ã‚¿ã‚¤ãƒãƒ¼ ====== */
function startTimer(){ clearInterval(timerInterval); timeElapsed=0; timerSpan.textContent=timeElapsed; timerInterval=setInterval(()=>{ timeElapsed++; timerSpan.textContent=timeElapsed; },1000); }
function stopTimer(){ clearInterval(timerInterval); }

/* ====== ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ ====== */
const levelButtons=document.getElementById("levelButtons");
for(let i=1;i<=30;i++){ const b=document.createElement("button"); b.textContent=i; b.className="level-btn"; b.onclick=()=>startGame(i); levelButtons.appendChild(b); }

/* ====== ã‚²ãƒ¼ãƒ é–‹å§‹ ====== */
function startGame(level){
  menu.style.display="none"; game.style.display="block"; stopTimer();
  fetch(`words_level${level}.csv`).then(r=>r.text()).then(t=>{
    words=t.trim().split("\n").map(l=>{
      const [en,jp]=l.split(",").map(s=>s.replace(/^['"]|['"]$/g,"").trim());
      return {en,jp};
    }).sort(()=>Math.random()-0.5);
    index=0; correct=0; wrongWords=[];
    showWord(); startTimer();
  }).catch(()=>alert("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"));
}

/* ====== å˜èªè¡¨ç¤º ====== */
function showWord(){
  if(index>=words.length){ finishGame(); return; }
  progress.textContent=`å•é¡Œ: ${index+1} / ${words.length}`;
  jpDiv.textContent=words[index].jp;
  wordDiv.textContent="";
  currentPos=0; wrongCount=0; hintShown=false; answerShown=false;
  input.value=""; input.focus();
}

/* ====== ç­”ãˆã‚’è¦‹ã‚‹ ====== */
function showAnswer(){
  const cur=words[index].en;
  wordDiv.innerHTML=`<span style="color:#1976d2">${cur}</span>`;
  hintShown=true;          // å¾©ç¿’å¯¾è±¡ã«å…¥ã‚Œã‚‹ãŸã‚
  answerShown=true;        // æ¬¡ã®ã‚¿ã‚¤ãƒ—ã§è¡¨ç¤ºã‚’æ¶ˆã™
  speak(cur);
}

/* ====== çµ‚äº† ====== */
function finishGame(){
  stopTimer(); playFinish();
  game.style.display="none"; resultCard.style.display="block";
  const total=words.length;
  const wpm=Math.max(0,Math.round(correct/(Math.max(1,timeElapsed)/60)));
  document.getElementById("finalScore").textContent=`æ™‚é–“ï¼š${timeElapsed}ç§’ / WPMï¼š${wpm}`;
  document.getElementById("summaryScore").textContent=`æ­£è§£ï¼š${correct} / ${total}å•`;

  // çµæœç”»é¢ã®ãƒœã‚¿ãƒ³ç”Ÿæˆï¼ˆé‡è¤‡é˜²æ­¢ã®ãŸã‚åˆæœŸåŒ–ï¼‰
  resultActions.innerHTML='<button onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>';
  if(wrongWords.length>0){
    const retry=document.createElement("button");
    retry.textContent="é–“é•ãˆãŸå˜èªã‚’å¾©ç¿’";
    retry.onclick=retryWrongWords;
    resultActions.appendChild(retry);
  }
}

/* ====== å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ ====== */
function retryWrongWords(){
  words=[...wrongWords];
  wrongWords=[]; index=0; correct=0;
  resultCard.style.display="none"; game.style.display="block";
  startTimer(); showWord();
}

/* ====== ãƒªã‚»ãƒƒãƒˆ ====== */
function resetGame(){ location.reload(); }

/* ====== å…¥åŠ›å‡¦ç†ï¼ˆç”»é¢å…¨ä½“ã§å—ã‘ã‚‹ï¼‰ ====== */
document.addEventListener("keydown",(e)=>{
  if(game.style.display==="none") return;     // ã‚²ãƒ¼ãƒ ä¸­ã®ã¿
  const key=e.key;
  if(key.length!==1) return;                  // æ–‡å­—ä»¥å¤–ã¯ç„¡è¦–
  e.preventDefault();                         // inputã«å…¥ã‚‰ãªã„ã‚ˆã†ã«

  const cur=words[index].en;
  if(currentPos>=cur.length) return;

  const typed=key.toLowerCase();
  const need=cur[currentPos].toLowerCase();

  // ã€Œç­”ãˆã‚’è¦‹ã‚‹ã€ç›´å¾Œã®æœ€åˆã®ã‚¿ã‚¤ãƒ—ã§è¡¨ç¤ºã‚’æ¶ˆã™
  if(answerShown){ answerShown=false; wordDiv.textContent=""; }

  if(typed===need){
    currentPos++; wrongCount=0;
    wordDiv.innerHTML=`<span style="color:#1976d2">${cur.slice(0,currentPos)}</span>`;
    if(currentPos===cur.length){
      // âœ… ä¸€åº¦ã§ã‚‚ãƒŸã‚¹ or ç­”ãˆã‚’è¦‹ãŸå˜èªã¯å¾©ç¿’å¯¾è±¡ã«ä¿å­˜
      if(wrongCount>0 || hintShown){ wrongWords.push(words[index]); }

      correct++; speak(cur);
      index++; setTimeout(showWord,1000);  // æ­£è§£å¾Œ 1 ç§’è¦‹ã›ã‚‹
    }
    return;
  }

  // ãƒŸã‚¹
  wrongCount++; result.innerHTML="<span class='wrong'>ãƒŸã‚¹ï¼</span>";
  setTimeout(()=>result.textContent="",300);
  playWrong();

  // 3å›ä»¥ä¸Šã§1æ–‡å­—ãƒ’ãƒ³ãƒˆ
  if(wrongCount>=3){
    wordDiv.innerHTML=
      `<span style="color:#1976d2">${cur.slice(0,currentPos)}</span>`+
      `<span style="color:red">${cur[currentPos]}</span>`;
  }
});

/* ====== ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒ ====== */
document.addEventListener("click",()=>input.focus());
document.addEventListener("touchstart",()=>input.focus());
document.addEventListener("mousemove",()=>{ if(document.activeElement!==input) input.focus(); });
</script>
</body>
</html>
