<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>英単語タイピング（中学生）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Noto Sans JP',sans-serif;
  margin:0;
  background:#f4f9ff;
  display:flex;justify-content:center;align-items:center;
  height:100vh;
}

.card{
  background:#fff;
  width:94%;max-width:520px;
  border-radius:16px;
  padding:20px;
  box-shadow:0 8px 16px rgba(0,0,0,0.1);
  text-align:center;
}

/* スマホ縦画面対応 */
@media (max-width:600px){
  .card{padding:16px;}
  h1{font-size:1.7em;}
  #word{font-size:2em;}
  #jp{font-size:1.2em;}
}

.level-btn{
  background:#1976d2;color:#fff;border:none;border-radius:10px;
  padding:8px;font-size:1em;cursor:pointer;
}
.level-btn:hover{background:#0d47a1}
.level-cleared{background:#4caf50!important}

/* === 画面下キーボード === */
#keyboard{
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:6px;
  padding:10px;
  position:fixed;
  bottom:0;left:0;right:0;
  background:#e3f2fd;
  border-top:2px solid #90caf9;
  z-index:100;
}
.key{
  background:#1976d2;color:white;border:none;
  padding:10px;
  border-radius:6px;
  font-size:1.1em;
  text-align:center;
}
.key:active{background:#0d47a1}

/* 入力エリアを下にずらす */
#game{padding-bottom:130px}

/* 入力欄 */
#input{
  width:90%;padding:10px;font-size:1.2em;
  border:2px solid #90caf9;border-radius:10px;
}
</style>
</head>

<body>
<div class="card" id="menu">
  <h1>英単語タイピング（中学生）</h1>
  <p id="clearProgress" style="font-weight:bold;color:#2e7d32"></p>

  <label><input type="radio" name="mode" id="testMode" checked>テスト</label>
  <label><input type="radio" name="mode" id="practiceMode">練習</label>

  <h2>レベル選択</h2>
  <div id="levelButtons" style="display:grid;grid-template-columns:repeat(10,1fr);gap:6px;"></div>

  <button id="resetClear" style="margin-top:10px;background:#888;color:#fff;border:none;padding:8px;border-radius:8px;">クリア履歴リセット</button>
</div>

<div class="card" id="game" style="display:none;">
  <h1>英単語タイピング</h1>
  <div id="progress"></div>
  <div>時間: <span id="timer">0</span>秒</div>
  <div id="jp"></div>
  <div id="word" style="min-height:60px;font-size:2.4em;"></div>

  <input id="input" placeholder="ここに入力">

  <button onclick="showAnswer()" id="btnAnswer" style="background:#ff9800;color:#fff;border:none;padding:8px;border-radius:6px;">答えを見る</button>
  <button onclick="resetGame()" style="background:#666;color:#fff;border:none;padding:8px;border-radius:6px;">リセット</button>

  <div id="result"></div>
</div>

<div id="resultCard" class="card" style="display:none;">
  <h1>結果</h1>
  <p id="finalScore"></p>
  <p id="summaryScore" style="font-weight:bold;font-size:1.3em;"></p>
  <div id="resultActions"></div>
</div>

<!-- ▼ ソフトキーボード -->
<div id="keyboard"></div>

<script>
let words=[],index=0,currentPos=0;
let wrongWords=[],hintShown=false,answerShown=false;
let timeElapsed=0,timerInterval=null;
let isPracticeMode=false,currentLevel=1;
let usedReview=false;

const jpDiv=document.getElementById("jp");
const wordDiv=document.getElementById("word");
const input=document.getElementById("input");

/* ▼ スマホ画面下キーボード生成 */
const keyboard=document.getElementById("keyboard");
"QWERTYUIOPASDFGHJKLZXCVBNM".split('').forEach(k=>{
  const btn=document.createElement("button");
  btn.textContent=k;btn.className="key";
  btn.onclick=()=> simulateKey(k);
  keyboard.appendChild(btn);
});

/* キー入力シミュレーション */
function simulateKey(ch){
  input.focus();
  document.dispatchEvent(new KeyboardEvent("keydown",{key:ch}));
}

/* 入力フォーカス時に画面調整 */
input.addEventListener("focus",()=>{
  setTimeout(()=>window.scrollTo(0,0),200);
});

/* タイマー */
function startTimer(){clearInterval(timerInterval);timeElapsed=0;
  timerInterval=setInterval(()=>{timeElapsed++;document.getElementById("timer").textContent=timeElapsed},1000);}
function stopTimer(){clearInterval(timerInterval);}

/* 初期UI */
function updateClearProgress(){
  let c=JSON.parse(localStorage.getItem("clearedLevels")||"[]");
  document.getElementById("clearProgress").textContent=`クリア: ${c.length} / 60`;
}
updateClearProgress();

/* レベルボタン */
const levelBox=document.getElementById("levelButtons");
let cleared=JSON.parse(localStorage.getItem("clearedLevels")||"[]");
for(let i=1;i<=60;i++){
  const b=document.createElement("button");
  b.textContent=i;b.className="level-btn";
  if(cleared.includes(i))b.classList.add("level-cleared");
  b.onclick=()=>startGame(i);
  levelBox.appendChild(b);
}

/* リセット */
document.getElementById("resetClear").onclick=()=>{
  localStorage.removeItem("clearedLevels");
  location.reload();
};

function startGame(l){
  currentLevel=l;
  isPracticeMode=document.getElementById("practiceMode").checked;
  usedReview=false;
  document.getElementById("menu").style.display="none";
  document.getElementById("game").style.display="block";

  fetch(`words_level${l}.csv`).then(r=>r.text()).then(t=>{
    words=t.trim().split("\n").map(l=>{
      const [en,jp]=l.split(",");
      return {en:en.trim(),jp:jp.trim()};
    });
    index=0;wrongWords=[];
    startTimer();showWord();
  });
}

function showWord(){
  if(index>=words.length){finishGame();return;}
  document.getElementById("progress").textContent=`${index+1}/${words.length}`;
  jpDiv.textContent=words[index].jp;
  currentPos=0;hintShown=false;answerShown=false;
  wordDiv.textContent="";
  input.value="";
}

function showAnswer(){
  if(isPracticeMode)return;
  wordDiv.innerHTML=`<span style="color:#1976d2">${words[index].en}</span>`;
  answerShown=true;
}

/* 終了処理 */
function finishGame(){
  stopTimer();
  document.getElementById("game").style.display="none";
  document.getElementById("resultCard").style.display="block";

  const review = wrongWords.length;
  const total = words.length;
  document.getElementById("finalScore").textContent=`時間：${timeElapsed}秒`;
  document.getElementById("summaryScore").textContent=`正解：${total-review}/${total}`;

  const actions=document.getElementById("resultActions");
  actions.innerHTML=`<button onclick="location.reload()">メニューへ</button>`;

  if(!isPracticeMode && review===0 && !usedReview){
    let c=JSON.parse(localStorage.getItem("clearedLevels")||"[]");
    if(!c.includes(currentLevel)){
      c.push(currentLevel);
      localStorage.setItem("clearedLevels",JSON.stringify(c));
    }
  }
}

/* 復習 */
function retryWrong(){
  usedReview=true;
  words=[...wrongWords];wrongWords=[];
  index=0;
  document.getElementById("resultCard").style.display="none";
  document.getElementById("game").style.display="block";
  startTimer();showWord();
}

document.addEventListener("keydown",e=>{
  if(document.getElementById("game").style.display==="none")return;
  const cur=words[index].en;
  if(e.key.length!==1)return;

  const t=e.key.toLowerCase(),need=cur[currentPos]?.toLowerCase();
  if(answerShown){answerShown=false;wordDiv.textContent="";}

  if(t===need){
    currentPos++;
    wordDiv.innerHTML=`<span style="color:#1976d2">${cur.slice(0,currentPos)}</span>`;
    if(currentPos===cur.length){
      index++;setTimeout(showWord,400);
    }
  }else{
    wrongWords.push(words[index]);
  }
});

function resetGame(){location.reload();}
</script>
</body>
</html>
