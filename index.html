<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #ffffff);
  display: flex; justify-content: center; align-items: center;
  height: 100vh; margin: 0;
}
.card {
  background: white; border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  padding: 40px; text-align: center; width: 90%; max-width: 500px;
}
h1 { color:#1976d2; margin-bottom:20px; }
button {
  background:#1976d2; color:white; border:none; padding:10px 25px;
  border-radius:10px; cursor:pointer; margin:5px; font-size:1em;
}
button:hover { background:#0d47a1; }
#jp { font-size:1.5em; margin:15px 0; }
#word { font-size:2em; min-height:60px; margin-bottom:10px; }
input {
  width:80%; padding:10px; font-size:1.2em; border:2px solid #90caf9; border-radius:10px;
}
#result { font-size:1.2em; height:40px; }
.wrong{color:red;font-weight:bold;}

/* â˜… ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã®5åˆ—ã‚°ãƒªãƒƒãƒ‰ */
#levelButtons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
  margin-top: 20px;
}
.level-btn {
  background:#1976d2; color:white; border:none;
  padding:10px; border-radius:10px; cursor:pointer; font-size:1.1em;
}
.level-btn:hover {
  background:#0d47a1;
}
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div class="card" id="menu">
  <h1>ãƒ¬ãƒ™ãƒ«é¸æŠ</h1>
  <div id="levelButtons"></div>
</div>

<!-- GAME -->
<div class="card" id="game" style="display:none;">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>
  <div>çµŒéæ™‚é–“: <span id="timer">0</span> ç§’</div>
  <div id="jp"></div>
  <div id="word"></div>
  <input type="text" id="input" autocomplete="off" placeholder="å…¥åŠ›">
  <div id="result"></div>
  <button onclick="toggleSound()" id="soundBtn">ğŸ”Š éŸ³ ON</button>
  <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- RESULT -->
<div class="card" id="resultCard" style="display:none;">
  <h1>çµæœ</h1>
  <p id="finalScore"></p>
  <button onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
</div>

<script>
let words = [], index=0, correct=0, currentPos=0, wrongCount=0, soundOn=true;
let timeElapsed = 0, timerInterval;

const jpDiv = document.getElementById("jp");
const wordDiv = document.getElementById("word");
const input = document.getElementById("input");
const result = document.getElementById("result");

/* â˜… Web Audioã§é™ã‹ãªåŠ¹æœéŸ³ */
function tone(freq = 440, duration = 0.15, type = "sine") {
  if(!soundOn) return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  gain.gain.value = 0.03; /* â† ã•ã‚‰ã«å°ã•ã„éŸ³é‡ */
  osc.connect(gain); gain.connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime + duration);
}

function playCorrect(){ tone(880,0.12); tone(1100,0.12); }
function playWrong(){ tone(200,0.15,"square"); }
function playFinish(){
  tone(440,0.2,"triangle");
  setTimeout(()=>tone(660,0.2,"triangle"),200);
  setTimeout(()=>tone(880,0.2,"triangle"),400);
}

/* ç™ºéŸ³ */
function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US"; speechSynthesis.speak(u);
}

/* éŸ³ON/OFF */
function toggleSound(){
  soundOn = !soundOn;
  document.getElementById("soundBtn").textContent = soundOn ? "ğŸ”Š éŸ³ ON" : "ğŸ”‡ éŸ³ OFF";
}

/* ã‚¿ã‚¤ãƒãƒ¼ */
function startTimer(){
  timerInterval = setInterval(()=>{
    timeElapsed++;
    document.getElementById("timer").textContent = timeElapsed;
  },1000);
}

/* ãƒ¬ãƒ™ãƒ«1ã€œ30ãƒœã‚¿ãƒ³ç”Ÿæˆ */
const levelButtons = document.getElementById("levelButtons");
for (let i = 1; i <= 30; i++) {
  const btn = document.createElement("button");
  btn.textContent = i;
  btn.className = "level-btn";
  btn.onclick = () => startGame(i);
  levelButtons.appendChild(btn);
}

/* ã‚²ãƒ¼ãƒ é–‹å§‹ */
function startGame(level){
  document.getElementById("menu").style.display="none";
  document.getElementById("game").style.display="block";

  fetch(`words_level${level}.csv`)
    .then(r=>r.text())
    .then(data=>{
      const lines = data.trim().split("\n");
      words = lines.map(l=>{
        const [en,jp] = l.split(",").map(s=>s.replace(/^['"]|['"]$/g,"").trim());
        return {en,jp};
      }).sort(()=>Math.random()-0.5);
      showWord(); startTimer();
    })
    .catch(()=> alert("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"));
}

/* å˜èªè¡¨ç¤º */
function showWord(){
  if(index>=words.length){ finishGame(); return; }
  const {en,jp} = words[index];
  jpDiv.textContent = jp;
  wordDiv.textContent = "";
  input.value=""; currentPos=0; wrongCount=0;
  input.focus();
}

/* çµ‚äº† */
function finishGame(){
  clearInterval(timerInterval);
  playFinish();
  document.getElementById("game").style.display="none";
  document.getElementById("resultCard").style.display="block";
  const wpm = Math.round(correct / (timeElapsed/60));
  document.getElementById("finalScore").textContent =
    `æ­£è§£æ•°ï¼š${correct}èª / æ™‚é–“ï¼š${timeElapsed}ç§’ / WPMï¼š${wpm}`;
}

/* ãƒªã‚»ãƒƒãƒˆ */
function resetGame(){ location.reload(); }

/* è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¿æŒ */
document.addEventListener("keydown",e=>{ if(document.activeElement !== input) input.focus(); });

/* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å‡¦ç† */
input.addEventListener("keydown",e=>{
  if(e.key.length!==1) return;
  e.preventDefault();
  const current = words[index].en;
  if(currentPos>=current.length) return;
  const correctChar = current[currentPos];

  if(e.key===correctChar){
    currentPos++; wrongCount=0;
    wordDiv.innerHTML=`<span style="color:#1976d2;">${current.slice(0,currentPos)}</span>`;
    if(currentPos===current.length){
      correct++; playCorrect(); speak(current);
      index++; setTimeout(showWord,200);
    }
    return;
  }

  wrongCount++; result.innerHTML="<span class='wrong'>ãƒŸã‚¹ï¼</span>";
  setTimeout(()=>result.textContent="",300); playWrong();

  if(wrongCount>=3){
    wordDiv.innerHTML=
      `<span style="color:#1976d2;">${current.slice(0,currentPos)}</span>`+
      `<span style="color:red;">${correctChar}</span>`;
  }
});
</script>

</body>
</html>
