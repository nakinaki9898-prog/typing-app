
ã‚ãªãŸ:
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆä¸­å­¦ç”Ÿï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
body{
  font-family:'Noto Sans JP',sans-serif;
  margin:0;display:flex;justify-content:center;align-items:center;
  min-height:100vh;
  background-color:#f4f9ff;
  background-image:
    linear-gradient(90deg, rgba(0,0,0,0.04) 1px, transparent 1px),
    linear-gradient(rgba(0,0,0,0.04) 1px, transparent 1px),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Ctext x='5' y='30' font-size='24' fill='%23bcd0e7' font-family='Arial'%3EABC%3C/text%3E%3Ctext x='60' y='80' font-size='22' fill='%23c8d9f0' font-family='Arial'%3Eabc%3C/text%3E%3C/svg%3E");
  background-size:40px 40px,40px 40px,120px 120px;
}
.card{
  background:rgba(255,255,255,0.92);
  border-radius:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  padding:40px;text-align:center;width:90%;max-width:520px;
}
h1{
  color:#1976d2;font-size:2.4em;font-weight:700;margin-bottom:16px;
}
#levelButtons{
  display:grid;grid-template-columns:repeat(10,1fr);gap:8px;
}
.level-btn{
  background:#1976d2;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;font-size:1em;
}
.level-btn:hover{background:#0d47a1}
.level-cleared{
  background:#4caf50!important;
  color:#fff;font-weight:bold;
}
button{
  background:#1976d2;color:#fff;padding:10px 24px;border-radius:10px;border:none;cursor:pointer;margin-top:8px;
}
button:hover{background:#0d47a1}
input{
  width:80%;padding:10px;font-size:1.2em;border:2px solid #90caf9;border-radius:10px;caret-color:transparent;user-select:none;
}
#word{
  font-size:2.6em;min-height:100px;margin-bottom:10px;
  display:flex;justify-content:center;align-items:center;text-align:center;
  width:100%;line-height:1.2;
}
#jp{font-size:1.5em;margin:15px 0}
#result{height:24px;margin-top:6px}
.wrong{color:red;font-weight:bold}
#progress{font-size:1.2em;margin-bottom:10px;color:#333;font-weight:bold}
.modeSelect{
  font-size:1.1em;margin-bottom:10px;
  display:flex;justify-content:center;align-items:center;gap:15px;
}
.modeSelect label{cursor:pointer;}
</style>
</head>
<body>

<!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="card" id="menu">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆä¸­å­¦ç”Ÿï¼‰</h1>

  <p id="clearProgress" style="font-weight:bold;color:#2e7d32;margin-bottom:10px;"></p>

  <div class="modeSelect">
    <label><input type="radio" name="mode" id="testMode" checked> ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</label>
    <label><input type="radio" name="mode" id="practiceMode"> ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</label>
  </div>

  <h2>ãƒ¬ãƒ™ãƒ«é¸æŠ</h2>
  <div id="levelButtons"></div>

  <button id="resetClear" style="margin-top:15px;background:#888">ã‚¯ãƒªã‚¢å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- ã‚²ãƒ¼ãƒ  -->
<div class="card" id="game" style="display:none;">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>
  <div id="progress"></div>
  <div>çµŒéæ™‚é–“: <span id="timer">0</span> ç§’</div>
  <div id="jp"></div>
  <div id="word"></div>

  <input id="input" readonly placeholder="ã“ã“ã«å…¥åŠ›">
  <button onclick="showAnswer()" id="btnAnswer" style="background:#ff9800;margin-top:6px;">ç­”ãˆã‚’è¦‹ã‚‹</button>

  <div id="result"></div>
  <button id="soundBtn" onclick="toggleSound()">ğŸ”Š éŸ³ ON</button>
  <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- çµæœ -->
<div class="card" id="resultCard" style="display:none;">
  <h1>çµæœ</h1>
  <p id="finalScore"></p>
  <p id="summaryScore" style="font-size:1.3em;font-weight:bold;"></p>
  <div id="resultActions"><button onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button></div>
</div>

<script>
let words=[],index=0,correct=0,currentPos=0;
let wrongCount=0,mistakeCount=0;
let wrongWords=[],hintShown=false,answerShown=false;
let soundOn=true,timeElapsed=0,timerInterval=null;
let isPracticeMode=false,currentLevel=1,originalTotal=25;

let usedReview = false; // âœ…å¾©ç¿’ã‚’ä½¿ã£ãŸã‹ã©ã†ã‹è¨˜éŒ²

const jpDiv=document.getElementById("jp");
const wordDiv=document.getElementById("word");
const input=document.getElementById("input");
const result=document.getElementById("result");
const menu=document.getElementById("menu");
const game=document.getElementById("game");
const resultActions=document.getElementById("resultActions");
const timerSpan=document.getElementById("timer");
const btnAnswer=document.getElementById("btnAnswer");
const radioPractice=document.getElementById("practiceMode");

/* ====== éŸ³ ====== */
function tone(f=440,d=0.15,t="sine"){
  if(!soundOn) return;
  const c=new(window.AudioContext||window.webkitAudioContext)();
  const o=c.createOscillator(), g=c.createGain();
  o.type=t;o.frequency.value=f;g.gain.value=0.15;
  o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+d);
}
function playCorrect(){tone(880,0.12);tone(1100,0.12);}
function playWrong(){tone(200,0.15,"square");}
function playFinish(){
  tone(440,0.2,"triangle");
  setTimeout(()=>tone(660,0.2,"triangle"),200);
  setTimeout(()=>tone(880,0.2,"triangle"),400);
}
function speak(t){const u=new SpeechSynthesisUtterance(t);u.lang="en-US";speechSynthesis.speak(u);}
function toggleSound(){
  soundOn=!soundOn;
  document.getElementById("soundBtn").textContent=soundOn?"ğŸ”Š éŸ³ ON":"ğŸ”‡ éŸ³ OFF";
}

/* ã‚¿ã‚¤ãƒ—éŸ³ã€Œã‚³ãƒƒã€ */
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
function clickKo(){
  if(!soundOn) return;
  const dur=0.07;
  const buffer=audioCtx.createBuffer(1,audioCtx.sampleRate*dur,audioCtx.sampleRate);
  const data=buffer.getChannelData(0);
  for(let i=0;i<data.length;i++){
    const env=Math.exp(-10*i/data.length);
    data[i]=(Math.random()*2-1)*env*0.6;
  }
  const src=audioCtx.createBufferSource();src.buffer=buffer;
  const gain=audioCtx.createGain();gain.gain.value=0.9;
  const filter=audioCtx.createBiquadFilter();filter.type="lowpass";filter.frequency.value=1500;
  src.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);src.start();
}

/* ã‚¿ã‚¤ãƒãƒ¼ */
function startTimer(){clearInterval(timerInterval);timeElapsed=0;timerInterval=setInterval(()=>{timeElapsed++;timerSpan.textContent=timeElapsed},1000);}
function stopTimer(){clearInterval(timerInterval);}

/* âœ…ã‚¯ãƒªã‚¢æ•°è¡¨ç¤º */
function updateClearProgress(){
  let clearedLevels = JSON.parse(localStorage.getItem("clearedLevels") || "[]");
  document.getElementById("clearProgress").textContent =
    âœ… ã‚¯ãƒªã‚¢ï¼š${clearedLevels.length} / 60ãƒ¬ãƒ™ãƒ«;
}
updateClearProgress();

/* ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ç”Ÿæˆ */
const levelContainer = document.getElementById("levelButtons");
let clearedLevels = JSON.parse(localStorage.getItem("clearedLevels") || "[]");

for(let i=1;i<=60;i++){
  const b=document.createElement("button");
  b.textContent=i;b.className="level-btn";
  if(clearedLevels.includes(i)) b.classList.add("level-cleared");
  b.onclick=()=>startGame(i);
  levelContainer.appendChild(b);
}

/* ã‚¯ãƒªã‚¢å±¥æ­´ãƒªã‚»ãƒƒãƒˆ */
document.getElementById("resetClear").onclick = () => {
  if(!confirm("ã‚¯ãƒªã‚¢å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem("clearedLevels");
  document.querySelectorAll("#levelButtons button").forEach(btn=>btn.classList.remove("level-cleared"));
  updateClearProgress();
  alert("ã‚¯ãƒªã‚¢å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼");
};

/* ã‚²ãƒ¼ãƒ é–‹å§‹ */
function startGame(level){
  currentLevel=level;
  isPracticeMode=radioPractice.checked;
  usedReview = false; // âœ…æ–°è¦ãƒ—ãƒ¬ã‚¤æ™‚ãƒªã‚»ãƒƒãƒˆ

  menu.style.display="none";game.style.display="block";
  btnAnswer.style.display=isPracticeMode?"none":"inline-block";
  stopTimer();

  fetch(words_level${level}.csv).then(r=>r.text()).then(t=>{
    words=t.trim().split("\n").map(l=>{
      const [en,jp]=l.split(",").map(s=>s.replace(/^['"]|['"]$/g,"").trim());
      return {en,jp};
    }).sort(()=>Math.random()-0.5);

    originalTotal=words.length;
    index=0;correct=0;wrongWords=[];
    showWord();startTimer();
  });
}

/* å˜èªè¡¨ç¤º */
function showWord(){
  if(index>=words.length){finishGame();return;}

  document.getElementById("progress").textContent = å•é¡Œï¼š${index+1} / ${originalTotal};

  const cur=words[index].en;
  jpDiv.textContent=words[index].jp;
  currentPos=0;wrongCount=0;mistakeCount=0;hintShown=false;answerShown=false;
  input.value="";input.focus();

  if(isPracticeMode){
    wordDiv.innerHTML=<div style="color:red;">${cur}</div>;
  } else wordDiv.textContent="";
}

/* ç­”ãˆ */
function showAnswer(){
  if(isPracticeMode) return;
  const cur=words[index].en;
  wordDiv.innerHTML=<span style="color:#1976d2">${cur}</span>;
  hintShown=true;answerShown=true;speak(cur);
}

/* çµæœ */
function finishGame(){
  stopTimer();playFinish();
  game.style.display="none";resultCard.style.display="block";

  const reviewCount=isPracticeMode?0:wrongWords.length;
  const total=originalTotal;
  const displayCorrect=Math.max(0,total-reviewCount);

  document.getElementById("finalScore").textContent=æ™‚é–“ï¼š${timeElapsed}ç§’;
  document.getElementById("summaryScore").textContent=æ­£è§£ï¼š${displayCorrect} / ${total}å•;

  resultActions.innerHTML='<button onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>';

  /* âœ…ä¸€ç™ºåˆæ ¼ã®ã¿ç·‘ã«ã™ã‚‹ */
  if(!isPracticeMode && wrongWords.length === 0 && !usedReview){
    let clearedLevels = JSON.parse(localStorage.getItem("clearedLevels") || "[]");
    if(!clearedLevels.includes(currentLevel)){
      clearedLevels.push(currentLevel);
      localStorage.setItem("clearedLevels", JSON.stringify(clearedLevels));
    }
    document.querySelectorAll("#levelButtons button")[currentLevel-1].classList.add("level-cleared");
    updateClearProgress();
  }

  /* ç·´ç¿’â†’ãƒ†ã‚¹ãƒˆã¸ */
  if(isPracticeMode){
    const goTest=document.createElement("button");
    goTest.textContent="åŒã˜ãƒ¬ãƒ™ãƒ«ã§ãƒ†ã‚¹ãƒˆã«æŒ‘æˆ¦";
    goTest.onclick=()=>{
      document.getElementById("testMode").checked=true;
      isPracticeMode=false;
      resultCard.style.display="none";game.style.display="block";
      startGame(currentLevel);
    };
    resultActions.appendChild(goTest);
  } else if(wrongWords.length>0){
    const retry=document.createElement("button");
    retry.textContent="é–“é•ãˆãŸå˜èªã‚’å¾©ç¿’";
    retry.onclick=retryWrongWords;
    resultActions.appendChild(retry);
  }
}

/* å¾©ç¿’ */
function retryWrongWords(){
  usedReview = true; // âœ…å¾©ç¿’ä½¿ç”¨è¨˜éŒ²
  words=[...wrongWords];wrongWords=[];
  index=0;correct=0;
  resultCard.style.display="none";game.style.display="block";
  startTimer();showWord();
}

function resetGame(){location.reload();}

/* å…¥åŠ›å‡¦ç† */
document.addEventListener("keydown",(e)=>{
  if(game.style.display==="none") return;
  if(e.key.length!==1) return;
  e.preventDefault();

  clickKo();
  const cur=words[index].en;
  if(currentPos>=cur.length) return;

  const typed=e.key.toLowerCase(),need=cur[currentPos].toLowerCase();
  if(answerShown){answerShown=false;wordDiv.textContent="";}

  if(typed===need){
    currentPos++;wrongCount=0;
    if(isPracticeMode){
      const t1=<span style="color:#1976d2">${cur.slice(0,currentPos)}</span>;
      const t2=<span style="color:red">${cur.slice(currentPos)}</span>;
      wordDiv.innerHTML=t1+t2;
    }else{
      wordDiv.innerHTML=<span style="color:#1976d2">${cur.slice(0,currentPos)}</span>;
    }

    if(currentPos===cur.length){
      if(!isPracticeMode && (mistakeCount>=3 || hintShown))
        wrongWords.push(words[index]);
      correct++;speak(cur);
      index++;setTimeout(showWord,800);
    }
    return;
  }

  wrongCount++;mistakeCount++;playWrong();
  result.innerHTML=<span class='wrong'>ãƒŸã‚¹ï¼</span>;
  setTimeout(()=>result.textContent="",300);

  if(!isPracticeMode && wrongCount>=3){
    wordDiv.innerHTML=
      <span style="color:#1976d2">${cur.slice(0,currentPos)}</span>+
      <span style="color:red">${cur[currentPos]}</span>;
  }
});

document.addEventListener("click",()=>input.focus());
document.addEventListener("touchstart",()=>input.focus());
</script>
</body>
</html>