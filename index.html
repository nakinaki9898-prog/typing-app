<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #ffffff);
  display: flex; justify-content: center; align-items: center;
  height: 100vh; margin: 0;
}
.card {
  background: white; border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  padding: 40px; text-align: center;
  width: 90%; max-width: 500px;
}
h1 { color:#1976d2; margin-bottom:20px; }
button {
  background:#1976d2; color:white; border:none;
  padding:10px 25px; border-radius:10px; cursor:pointer; margin:5px;
}
button:hover { background:#0d47a1; }
#jp { font-size:1.5em; margin:15px 0; }
#word { font-size:2em; min-height:60px; margin-bottom:10px; }
input {
  width:80%; padding:10px; font-size:1.2em;
  border:2px solid #90caf9; border-radius:10px;
}
#result { font-size:1.2em; height:40px; }
.wrong{color:red;font-weight:bold;}
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div class="card" id="menu">
  <h1>ãƒ¬ãƒ™ãƒ«é¸æŠ</h1>
  <button onclick="startGame(1)">LEVEL 1</button>
  <button onclick="startGame(2)">LEVEL 2</button>
  <button onclick="startGame(3)">LEVEL 3</button>
  <button onclick="startGame(4)">LEVEL 4</button>
  <button onclick="startGame(5)">LEVEL 5</button>
</div>

<!-- GAME SCREEN -->
<div class="card" id="game" style="display:none;">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>
  <div>çµŒéæ™‚é–“: <span id="timer">0</span> ç§’</div>
  <div id="jp"></div>
  <div id="word"></div>
  <input type="text" id="input" autocomplete="off" placeholder="å…¥åŠ›">
  <div id="result"></div>
  <button onclick="toggleSound()" id="soundBtn">ğŸ”Š éŸ³ ON</button>
  <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- RESULT SCREEN -->
<div class="card" id="resultCard" style="display:none;">
  <h1>çµæœ</h1>
  <p id="finalScore"></p>
  <button onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
</div>

<script>
let words = [], index=0, correct=0, currentPos=0, wrongCount=0, soundOn=true;
let timeElapsed = 0, timerInterval;
const jpDiv = document.getElementById("jp");
const wordDiv = document.getElementById("word");
const input = document.getElementById("input");
const result = document.getElementById("result");

function tone(freq = 440, duration = 0.15, type = "sine") {
  if(!soundOn) return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.type = type;
  osc.frequency.value = freq;
  osc.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + duration);
}
function playCorrect(){ tone(880,0.12,"sine"); tone(1100,0.12,"sine"); }
function playWrong(){ tone(200,0.12,"square"); }
function playFinish(){
  tone(440,0.2,"triangle");
  setTimeout(()=>tone(660,0.2,"triangle"),200);
  setTimeout(()=>tone(880,0.2,"triangle"),400);
}

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US"; speechSynthesis.speak(u);
}

function toggleSound(){
  soundOn = !soundOn;
  document.getElementById("soundBtn").textContent = soundOn ? "ğŸ”Š éŸ³ ON" : "ğŸ”‡ éŸ³ OFF";
}

function startTimer(){
  timerInterval = setInterval(()=>{
    timeElapsed++;
    document.getElementById("timer").textContent = timeElapsed;
  },1000);
}

function startGame(level){
  document.getElementById("menu").style.display="none";
  document.getElementById("game").style.display="block";

  fetch(`words_level${level}.csv`)
    .then(r=>r.text())
    .then(data=>{
      const lines = data.trim().split("\n");
      words = lines.map(l=>{
        const [en,jp] = l.split(",").map(s=>s.replace(/^['"]|['"]$/g,"").trim());
        return {en,jp};
      }).sort(()=>Math.random()-0.5);

      showWord();
      startTimer();
    });
}

function showWord(){
  if(index>=words.length){ finishGame(); return; }
  const {en,jp} = words[index];
  jpDiv.textContent = jp;
  wordDiv.textContent = "";
  input.value=""; currentPos=0; wrongCount=0;
  input.focus();
}

function finishGame(){
  clearInterval(timerInterval);
  playFinish();
  document.getElementById("game").style.display="none";
  document.getElementById("resultCard").style.display="block";

  const wpm = Math.round(correct / (timeElapsed/60));
  document.getElementById("finalScore").textContent =
    `æ­£è§£æ•°ï¼š${correct}èª / æ™‚é–“ï¼š${timeElapsed}ç§’ / WPMï¼š${wpm}`;
}

function resetGame(){ location.reload(); }

document.addEventListener("keydown",e=>{
  if(document.activeElement !== input) input.focus();
});

input.addEventListener("keydown",e=>{
  if(e.key.length!==1) return;
  e.preventDefault();
  const current = words[index].en;
  if(currentPos>=current.length) return;
  const correctChar = current[currentPos];

  if(e.key===correctChar){
    currentPos++; wrongCount=0;

    const typed=current.slice(0,currentPos);
    wordDiv.innerHTML=`<span style="color:#1976d2;">${typed}</span>`;

    if(currentPos===current.length){
      correct++; playCorrect(); speak(current);
      index++; setTimeout(showWord,200);
    }
    return;
  }

  wrongCount++; result.innerHTML="<span class='wrong'>ãƒŸã‚¹ï¼</span>";
  setTimeout(()=>result.textContent="",300);
  playWrong();

  if(wrongCount>=3){
    const correctPart=current.slice(0,currentPos);
    const hintChar=correctChar;
    wordDiv.innerHTML=
      `<span style="color:#1976d2;">${correctPart}</span>`+
      `<span style="color:red;">${hintChar}</span>`;
  }
});
</script>
</body>
</html>
