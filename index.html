<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆä¸­å­¦ç”Ÿï¼‰</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Mochiy+Pop+One&display=swap" rel="stylesheet">

<style>
/* åŸºç¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
body {
  font-family: 'Noto Sans JP', sans-serif;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

/* ã‚«ãƒ¼ãƒ‰ */
.card {
  background: rgba(255,255,255,0.92);
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  padding: 40px;
  text-align: center;
  width: 90%;
  max-width: 480px;
}

h1 { 
  color:#1976d2;
  font-family: 'Mochiy Pop One', sans-serif;
}

/* ãƒ¬ãƒ™ãƒ«é¸æŠ */
#levelButtons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
}
.level-btn {
  background:#1976d2; color:#fff;
  padding:10px; border-radius:10px;
  border:none; cursor:pointer; font-size:1.1em;
}
.level-btn:hover { background:#0d47a1; }

/* ãƒœã‚¿ãƒ³ */
button {
  background:#1976d2; color:white;
  padding:10px 25px; border-radius:10px;
  cursor:pointer; border:none; 
  margin-top: 10px;
}
button:hover { background:#0d47a1; }

/* å…¥åŠ›æ¬„ */
input {
  width:80%; padding:10px; font-size:1.2em;
  border:2px solid #90caf9; border-radius:10px;
}

/* å˜èªè¡¨ç¤º */
#jp { font-size:1.5em; margin:15px 0; }
#word { font-size:2em; min-height:60px; margin-bottom:10px; }
.wrong { color:red; font-weight:bold; }

/* === èƒŒæ™¯ï¼ˆå¿…ãšåæ˜ ç‰ˆï¼‰ === */
#bg {
  background-color: #e8f3ff !important;
  background-image:
    url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nNjAnIGhlaWdodD0nNjAnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc+PHJlY3Qgd2lkdGg9JzYwJyBoZWlnaHQ9JzYwJyBmaWxsPSIjZWZmNyIvPjxnIGZpbGw9IiNhOGNkZmYiIGZpbGwtb3BhY2l0eT0iMC40Ij48Y2lyY2xlIGN4PSIxNSIgY3k9IjE0IiByPSI0Ii8+PHJlY3QgeD0iMzAiIHk9IjMxIiB3aWR0aD0iOCIgaGVpZ2h0PSIzIi8+PC9nPjx0ZXh0IHg9IjE4IiB5PSI0NyIgZm9udC1zaXplPSIxMCIgZmlsbD0iI2E2YTZhNiI+QUJDPjwvdGV4dD48L3N2Zz4=");
  background-size: 140px;
  background-repeat: repeat !important;
  min-height: 100vh;
}
</style>
</head>

<body id="bg">

<!-- ãƒ¬ãƒ™ãƒ«é¸æŠç”»é¢ -->
<div class="card" id="menu">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆä¸­å­¦ç”Ÿï¼‰</h1>
  <h2>ãƒ¬ãƒ™ãƒ«é¸æŠ</h2>
  <div id="levelButtons"></div>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div class="card" id="game" style="display:none;">
  <h1>è‹±å˜èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>
  <div>çµŒéæ™‚é–“: <span id="timer">0</span> ç§’</div>
  <div id="jp"></div>
  <div id="word"></div>

  <input id="input"
    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="latin"
    placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„">

  <div id="result"></div>
  <button onclick="toggleSound()" id="soundBtn">ğŸ”Š éŸ³ ON</button>
  <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- çµæœç”»é¢ -->
<div class="card" id="resultCard" style="display:none;">
  <h1>çµæœ</h1>
  <p id="finalScore"></p>
  <button onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
</div>

<script>
let words=[], index=0, correct=0, currentPos=0, wrongCount=0, soundOn=true;
let wrongWords=[];   // â†è¿½åŠ ï¼šé–“é•ãˆãŸå˜èªãƒªã‚¹ãƒˆ
let timeElapsed=0, timerInterval;

const jpDiv=document.getElementById("jp");
const wordDiv=document.getElementById("word");
const input=document.getElementById("input");
const result=document.getElementById("result");

function tone(f=440,d=0.15,t="sine"){
  if(!soundOn) return;
  const ctx=new(window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator(), gain=ctx.createGain();
  osc.type=t; osc.frequency.value=f; gain.gain.value=0.03;
  osc.connect(gain); gain.connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime+d);
}
function playCorrect(){ tone(880,0.12); tone(1100,0.12); }
function playWrong(){ tone(200,0.15,"square"); }
function playFinish(){
  tone(440,0.2,"triangle");
  setTimeout(()=>tone(660,0.2,"triangle"),200);
  setTimeout(()=>tone(880,0.2,"triangle"),400);
}
function playStart(){ tone(600,0.12); tone(900,0.12); }

function speak(t){ const u=new SpeechSynthesisUtterance(t); u.lang="en-US"; speechSynthesis.speak(u); }
function toggleSound(){ soundOn=!soundOn; soundBtn.textContent=soundOn?"ğŸ”Š éŸ³ ON":"ğŸ”‡ éŸ³ OFF"; }

function startTimer(){
  timerInterval=setInterval(()=>{
    timeElapsed++;
    document.getElementById("timer").textContent=timeElapsed;
  },1000);
}

/* ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ä½œæˆ */
const levelButtons=document.getElementById("levelButtons");
for(let i=1;i<=30;i++){
  const b=document.createElement("button");
  b.textContent=i; b.className="level-btn";
  b.onclick=()=>startGame(i);
  levelButtons.appendChild(b);
}

function startGame(level){
  playStart();
  menu.style.display="none";
  game.style.display="block";

  fetch(`words_level${level}.csv`)
  .then(r=>r.text())
  .then(t=>{
    words=t.trim().split("\n").map(l=>{
      const[a,b]=l.split(",").map(x=>x.replace(/^['"]|['"]$/g,"").trim());
      return {en:a, jp:b};
    }).sort(()=>Math.random()-0.5);

    index=0; correct=0; timeElapsed=0; wrongWords=[];
    showWord(); startTimer();
  });
}

function showWord(){
  if(index>=words.length) return finishGame();
  const {en,jp}=words[index];
  jpDiv.textContent=jp; wordDiv.textContent="";
  input.value=""; currentPos=0; wrongCount=0;
  input.focus();
}

function finishGame(){
  clearInterval(timerInterval);
  playFinish();
  game.style.display="none";
  resultCard.style.display="block";

  const wpm=Math.round(correct/(timeElapsed/60));
  finalScore.textContent=`æ­£è§£æ•°ï¼š${correct} / æ™‚é–“ï¼š${timeElapsed}ç§’ / WPMï¼š${wpm}`;

  // ğŸ” å¾©ç¿’ãƒœã‚¿ãƒ³ï¼ˆé–“é•ãˆãŸå˜èªãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
  if (wrongWords.length > 0) {
    const retryBtn=document.createElement("button");
    retryBtn.textContent="é–“é•ãˆãŸå˜èªã‚’å¾©ç¿’";
    retryBtn.onclick=retryWrongWords;
    resultCard.appendChild(retryBtn);
  }
}

function resetGame(){ location.reload(); }

function retryWrongWords(){
  words=[...wrongWords];
  wrongWords=[];
  index=0; correct=0; timeElapsed=0;
  resultCard.style.display="none";
  game.style.display="block";
  showWord(); startTimer();
}

/* ã‚¹ãƒãƒ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ */
document.addEventListener("touchstart",()=>input.focus());
document.addEventListener("keydown",()=>{ if(document.activeElement!==input) input.focus(); });

/* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°åˆ¤å®š */
input.addEventListener("keydown",e=>{
  if(e.key.length!==1) return;
  e.preventDefault();
  const cur=words[index].en;
  if(currentPos>=cur.length) return;
  const c=cur[currentPos];

  if(e.key===c){
    currentPos++; wrongCount=0;
    wordDiv.innerHTML=`<span style="color:#1976d2">${cur.slice(0,currentPos)}</span>`;
    if(currentPos===cur.length){
      // âœ… é–“é•ãˆãŸå˜èªã‚’è¨˜éŒ²
      if (wrongCount > 0) wrongWords.push(words[index]);

      correct++; playCorrect(); speak(cur);
      index++;
      setTimeout(showWord,1000);
    }
    return;
  }

  wrongCount++; result.innerHTML="<span class='wrong'>ãƒŸã‚¹ï¼</span>";
  setTimeout(()=>result.textContent="",300); playWrong();

  if(wrongCount>=3){
    wordDiv.innerHTML=
      `<span style="color:#1976d2">${cur.slice(0,currentPos)}</span>`+
      `<span style="color:red">${c}</span>`;
  }
});
</script>
</body>
</html>
